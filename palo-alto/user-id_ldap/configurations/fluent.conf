<source>
  @type tail
  read_from_head true
  path /fluentd/log/files/messages
  pos_file /tmp/container-logs.pos
  tag ldap-access.log
  <parse>
  @type multiline
  format_firstline /\w+\s+\d+ \d+.\d+.\d+ [\w+|-]+ \w+\[\d+\]\: \w+ conn=\d+ fd=\d+ ACCEPT from/
  format1 /(?<timestamp>\w+\s+\d+ \d+.\d+.\d+).+?(?=IP=)IP=(?<ip>\d+.\d+.\d+.\d+).+?(?=\n)/
  format2 /.+?(?=\n)\n/
  format3 /.+?(?=\n)\n/
  format4 /.+?(?=tag=97)tag=97.+?(?=\n)\n/
  format5 /.+?(?=\n)\n/
  format6 /.+?(?=\n)\n/
  format7 /.+?(?=\n)\n/
  format8 /.+?(?=\n)\n/
  format9 /.+?(?=\n)\n/
  format10 /.+?(?=cn)cn=(?<username>\w+),cn=(?<group>\w+).+?(?=\n)\n/
  format11 /.+?(?=tag=97)tag=97.+?(?=\n)\n/
  format12 /.+?(?=\n)\n/
  format13 /.+?(?=\n)\n/
  format14 /.+?(?=\n)\n/
  format15 /.+?(?=tag=97)tag=97.+?(?=\n)\n/
  format16 /.+?(?=UNBIND)UNBIND\n/
  format17 /.+?(?=closed)closed\n/
  </parse>
</source>

<match ldap-access.log>
  @type exec
  command python /output/user_id_update.py
  buffer_path /output
  format tsv
  keys timestamp,ip,username,group
  flush_interval 5s
</match>
